<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Cloud Storage</title>
    <link rel="icon" href="https://fav.farm/‚òÅÔ∏è" />
    <style>
        /* --- UNIFIED THEME VARIABLES (Matches Index/Code) --- */
        :root {
            /* Dark Mode (Default) */
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #334155;
            --input-bg: #0f172a;
            --success-color: #22c55e;
            --danger-color: #ef4444;
        }

        /* Light Mode Overrides */
        [data-theme="light"] {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #0f172a;
            --text-secondary: #64748b;
            --accent-color: #2563eb;
            --accent-hover: #1d4ed8;
            --border-color: #e2e8f0;
            --input-bg: #f1f5f9;
            --success-color: #16a34a;
            --danger-color: #dc2626;
        }

        /* --- GLOBAL STYLES --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Aligns to top to prevent jumping */
            min-height: 100vh;
            padding: 40px 20px;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 750px; /* Matched width */
            position: relative;
            border: 1px solid var(--border-color);
            min-height: 600px; /* Matched height */
        }

        /* --- HEADER (Exactly matching code.html) --- */
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            height: 40px; 
        }
        
        .repo-link { 
            font-size: 0.85rem; 
            color: var(--accent-color); 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-weight: 500;
            opacity: 0.9; 
        }
        .repo-link:hover { opacity: 1; text-decoration: underline; }
        
        .header-actions { display: flex; gap: 10px; }

        .theme-toggle, .btn-reset { 
            background: none; 
            border: 1px solid var(--border-color); 
            cursor: pointer; 
            color: var(--text-color); 
            padding: 6px 12px; /* FIXED: Matches code.html */
            border-radius: 8px; 
            font-size: 0.85rem; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 32px;
        }
        .theme-toggle:hover, .btn-reset:hover { background: var(--input-bg); transform: translateY(-1px); border-color: var(--text-secondary); }

        /* --- NAVIGATION TABS (Exactly matching code.html) --- */
        .nav-container {
            display: flex;
            background-color: var(--input-bg);
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 25px; /* FIXED: Matches code.html */
            border: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0; /* FIXED: Matches code.html */
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            display: block;
        }

        .nav-tab:hover { color: var(--text-color); background-color: rgba(125, 125, 125, 0.1); }

        .nav-tab.active {
            background-color: var(--card-bg);
            color: var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        h1 { text-align: center; margin: 10px 0 5px 0; font-size: 2rem; letter-spacing: -0.5px; }
        .subtitle { text-align: center; color: var(--text-secondary); font-size: 1rem; margin-bottom: 25px; }

        /* --- CLOUD SPECIFIC STYLES --- */
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: var(--accent-color); }

        button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        button:hover { background-color: var(--accent-hover); }
        button:active { transform: scale(0.98); }

        button.secondary { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        button.secondary:hover { background-color: var(--input-bg); }

        .stats-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .limit-badge {
            background: var(--input-bg);
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-weight: 500;
            color: var(--text-color);
        }

        .storage-track {
            width: 100%;
            height: 8px;
            background-color: var(--input-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .storage-fill {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.5s ease;
        }
        .storage-fill.warning { background-color: #f59e0b; }
        .storage-fill.danger { background-color: var(--danger-color); }

        .upload-area {
            border: 2px dashed var(--border-color);
            padding: 2.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            background-color: var(--input-bg);
            transition: border-color 0.3s;
            text-align: center;
        }
        .upload-area:hover { border-color: var(--accent-color); }
        
        .file-list { margin-top: 1.5rem; text-align: left; max-height: 400px; overflow-y: auto; }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .file-link {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.95rem;
            word-break: break-all;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-link:hover { text-decoration: underline; }

        .file-meta { font-size: 0.8rem; color: var(--text-secondary); margin-right: 15px; }

        button.delete-btn {
            background-color: transparent;
            color: var(--text-secondary);
            width: auto;
            padding: 6px;
            margin: 0;
            font-size: 1.1rem;
            border: 1px solid transparent;
        }
        button.delete-btn:hover { color: var(--danger-color); background-color: rgba(239, 68, 68, 0.1); border-color: var(--danger-color); }

        #progress-container { width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-top: 15px; display: none; overflow: hidden;}
        #progress-bar { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.2s; }

        .hidden { display: none !important; }
        .error-msg { color: var(--danger-color); font-size: 0.9rem; margin-top: 0.5rem; }

    </style>
</head>
<body>

<div class="container">
    
    <div class="header-top">
        <a href="https://github.com/ROYALKINGSJ/attendance-calculator" target="_blank" class="repo-link">
            <svg height="18" width="18" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            GitHub
            <span id="last-updated" style="margin-left: 5px; opacity: 0.6; font-family: monospace; font-size: 0.75rem;"></span>
        </a>
        
        <div class="header-actions">
            <button class="btn-reset" onclick="location.reload()" title="Refresh Page">‚Ü∫ Refresh</button>
            <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">‚òÄÔ∏è Light Mode</button>
        </div>
    </div>

    <div class="nav-container">
        <a href="index.html" class="nav-tab">üìä Attendance</a>
        <a href="code.html" class="nav-tab">üíª Code</a>
        <div class="nav-tab active">‚òÅÔ∏è Cloud</div>
    </div>

    <div id="auth-view">
        <h1>üîê Student Login</h1>
        <p class="subtitle">Secure temporary storage (24h)<br>‚Ä¢ Max 3 uploads per day ‚Ä¢</p>
        
        <input type="text" id="app-num" placeholder="Application Number (e.g. 125xxxxxx)">
        <input type="password" id="password" placeholder="Password">
        
        <button onclick="login()">Access Cloud</button>
        <button class="secondary" onclick="register()">First Time? Create Account</button>
        <p id="auth-error" class="error-msg"></p>
    </div>

    <div id="app-view" class="hidden">
        <h1>‚òÅÔ∏è My Cloud</h1>
        <p class="subtitle" id="user-display">Loading...</p>

        <div class="stats-container">
            <span class="limit-badge" id="daily-limit-text">Uploads: 0/3</span>
            <span id="storage-text">0 MB / 25 MB</span>
        </div>
        <div class="storage-track">
            <div class="storage-fill" id="storage-fill"></div>
        </div>

        <div class="upload-area">
            <input type="file" id="file-input" style="display:none" onchange="handleFileSelect()">
            <button class="secondary" onclick="document.getElementById('file-input').click()" style="width:auto; margin:0;">üìÇ Select File</button>
            <p id="selected-file" style="margin: 15px 0 0 0; font-size: 0.9rem; font-style: italic; color: var(--text-secondary);"></p>
            
            <div id="progress-container"><div id="progress-bar"></div></div>
            <button onclick="uploadFile()" id="upload-btn" class="hidden" style="margin-top: 20px;">‚¨ÜÔ∏è Upload to Cloud</button>
        </div>

        <h3 style="text-align: left; margin-bottom: 10px; color: var(--text-color);">My Files</h3>
        <div id="file-list" class="file-list">
            </div>

        <button class="secondary" onclick="logout()" style="margin-top: 2rem;">Log Out</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll, deleteObject, getMetadata } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDoQiGwshPRK-AJd8u7tPl3CZqb0ILZcpE",
      authDomain: "mit-student-hub-2.firebaseapp.com",
      projectId: "mit-student-hub-2",
      storageBucket: "mit-student-hub-2.firebasestorage.app",
      messagingSenderId: "853660811565",
      appId: "1:853660811565:web:bc6660f73f8b88795c93a4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const db = getFirestore(app);
    const DOMAIN = "@mit.app"; 

    // --- CONSTANTS ---
    const MAX_STORAGE_BYTES = 25 * 1024 * 1024; // 25 MB
    const DAILY_UPLOAD_LIMIT = 3;
    let currentUsedBytes = 0;
    let uploadsToday = 0;

    // --- THEME SYNC ---
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateThemeIcon(savedTheme);

    window.toggleTheme = () => {
        const current = document.documentElement.getAttribute("data-theme");
        const newTheme = current === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);
    }
    function updateThemeIcon(theme) { document.getElementById("theme-icon").innerText = theme === "light" ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode"; }

    // --- GITHUB DATE FETCH ---
    const REPO_USER = "ROYALKINGSJ";
    const REPO_NAME = "attendance-calculator"; 
    
    async function fetchLastUpdated() {
        const textEl = document.getElementById('last-updated');
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO_USER}/${REPO_NAME}/commits?per_page=1`);
            const data = await res.json();
            const date = new Date(data[0].commit.author.date);
            textEl.innerText = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        } catch (e) { console.log("Date fetch failed"); }
    }
    fetchLastUpdated();

    // --- AUTH ---
    function getEmail(appNum) { return appNum.trim() + DOMAIN; }
    function getAppNum(email) { return email.replace(DOMAIN, ""); }

    window.login = async () => {
        const appNum = document.getElementById('app-num').value.trim();
        const pass = document.getElementById('password').value;
        if(!appNum || !pass) return showError("Please enter all fields.");
        try { await signInWithEmailAndPassword(auth, getEmail(appNum), pass); } 
        catch (error) { showError("Invalid App Number or Password."); }
    };

    window.register = async () => {
        const appNum = document.getElementById('app-num').value.trim();
        const pass = document.getElementById('password').value;
        if(!appNum || !pass) return showError("Please enter all fields.");
        const btn = document.querySelector('#auth-view button.secondary');
        const originalText = btn.innerText;
        btn.innerText = "Checking..."; btn.disabled = true;
        try {
            const docRef = doc(db, "whitelist", appNum);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) throw new Error("‚õî Number not found in Whitelist.");
            await createUserWithEmailAndPassword(auth, getEmail(appNum), pass);
        } catch (error) {
            let msg = error.message;
            if(msg.includes("email-already-in-use")) msg = "Account exists! Please Log In.";
            if(msg.includes("weak-password")) msg = "Password must be 6+ chars.";
            showError(msg);
        } finally { btn.innerText = originalText; btn.disabled = false; }
    };

    window.logout = () => signOut(auth);
    function showError(msg) { document.getElementById('auth-error').innerText = msg; }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('user-display').innerText = "Student ID: " + getAppNum(user.email);
            loadFiles(user.uid);
            checkDailyLimit(user.uid); 
        } else {
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('auth-view').classList.remove('hidden');
            document.getElementById('file-list').innerHTML = "";
            currentUsedBytes = 0;
        }
    });

    // --- DAILY LIMIT LOGIC ---
    async function checkDailyLimit(uid) {
        const todayStr = new Date().toISOString().split('T')[0];
        const statsRef = doc(db, "user_stats", uid);
        
        try {
            const docSnap = await getDoc(statsRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.date === todayStr) {
                    uploadsToday = data.count || 0;
                } else {
                    uploadsToday = 0; // New day
                }
            } else {
                uploadsToday = 0;
            }
            updateStatsUI();
        } catch (error) {
            console.error("Error fetching stats:", error);
        }
    }

    async function incrementDailyCount(uid) {
        const todayStr = new Date().toISOString().split('T')[0];
        const statsRef = doc(db, "user_stats", uid);
        uploadsToday++;
        await setDoc(statsRef, { date: todayStr, count: uploadsToday });
        updateStatsUI();
    }

    function updateStatsUI() {
        const el = document.getElementById('daily-limit-text');
        el.innerText = `Uploads: ${uploadsToday}/${DAILY_UPLOAD_LIMIT}`;
        
        if (uploadsToday >= DAILY_UPLOAD_LIMIT) {
            el.style.borderColor = "var(--danger-color)";
            el.style.color = "var(--danger-color)";
        } else {
            el.style.borderColor = "var(--border-color)";
            el.style.color = "var(--text-color)";
        }
    }

    // --- STORAGE LOGIC ---
    let selectedFile = null;
    
    window.handleFileSelect = () => {
        const file = document.getElementById('file-input').files[0];
        if (!file) return;

        // 1. CHECK DAILY LIMIT
        if (uploadsToday >= DAILY_UPLOAD_LIMIT) {
            alert(`‚õî Daily Limit Reached!\n\nYou have already uploaded ${DAILY_UPLOAD_LIMIT} files today.\nPlease come back tomorrow.`);
            document.getElementById('file-input').value = ""; 
            return;
        }
        
        // 2. CHECK STORAGE LIMIT
        const expectedTotal = currentUsedBytes + file.size;
        if (expectedTotal > MAX_STORAGE_BYTES) {
            alert(`‚ö†Ô∏è Not enough space! Limit is 25MB.`);
            document.getElementById('file-input').value = ""; 
            return;
        }
        
        selectedFile = file;
        document.getElementById('selected-file').innerText = "Selected: " + file.name + ` (${(file.size/1024/1024).toFixed(2)} MB)`;
        document.getElementById('upload-btn').classList.remove('hidden');
    }

    window.uploadFile = () => {
        if (!selectedFile) return;
        const user = auth.currentUser;
        if (!user) return;

        // Double check limits
        if (uploadsToday >= DAILY_UPLOAD_LIMIT) { alert("‚õî Daily limit reached."); return; }
        if (currentUsedBytes + selectedFile.size > MAX_STORAGE_BYTES) { alert("‚õî Storage limit reached."); return; }

        const storageRef = ref(storage, `uploads/${user.uid}/${selectedFile.name}`);
        const uploadTask = uploadBytesResumable(storageRef, selectedFile);

        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('upload-btn').disabled = true;

        uploadTask.on('state_changed', 
            (snapshot) => { 
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById('progress-bar').style.width = progress + '%'; 
            }, 
            (error) => { 
                alert("Upload Failed: " + error.message);
                resetUploadUI();
            }, 
            async () => { 
                // SUCCESS!
                await incrementDailyCount(user.uid); 
                alert("‚úÖ Upload Successful!"); 
                resetUploadUI();
                loadFiles(user.uid); 
            }
        );
    };

    function resetUploadUI() {
        selectedFile = null;
        document.getElementById('file-input').value = "";
        document.getElementById('selected-file').innerText = "";
        document.getElementById('upload-btn').classList.add('hidden');
        document.getElementById('upload-btn').disabled = false;
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('progress-bar').style.width = '0%';
    }

    window.deleteFile = async (fileName) => {
        const user = auth.currentUser;
        if (!user || !confirm(`Delete "${fileName}"?`)) return;

        const fileRef = ref(storage, `uploads/${user.uid}/${fileName}`);
        try {
            await deleteObject(fileRef);
            loadFiles(user.uid); 
        } catch (error) {
            alert("Error deleting: " + error.message);
        }
    }

    // --- LOAD FILES ---
    async function loadFiles(uid) {
        const listRef = ref(storage, `uploads/${uid}`);
        const listContainer = document.getElementById('file-list');
        listContainer.innerHTML = '<div style="text-align:center; color:var(--text-secondary)">Loading...</div>';

        try {
            const res = await listAll(listRef);
            const filePromises = res.items.map(async (itemRef) => {
                const url = await getDownloadURL(itemRef);
                const meta = await getMetadata(itemRef);
                return { ref: itemRef, url, meta };
            });

            const files = await Promise.all(filePromises);
            
            // Calculate Total Size
            currentUsedBytes = files.reduce((acc, file) => acc + Number(file.meta.size), 0);
            updateStorageUI();

            // Render
            listContainer.innerHTML = "";
            if (files.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; margin-top:20px; color:var(--text-secondary)">No files uploaded.</div>';
                return;
            }

            files.forEach(file => {
                const sizeMB = (Number(file.meta.size) / (1024 * 1024)).toFixed(2);
                listContainer.innerHTML += `
                    <div class="file-item">
                        <div style="flex-grow:1; display:flex; align-items:center;">
                            <a href="${file.url}" target="_blank" class="file-link">üìÑ ${file.ref.name}</a>
                            <span class="file-meta">(${sizeMB} MB)</span>
                        </div>
                        <button class="delete-btn" onclick="deleteFile('${file.ref.name}')" title="Delete">üóëÔ∏è</button>
                    </div>`;
            });

        } catch (error) {
            console.error(error);
            listContainer.innerHTML = '<div style="text-align:center; color:var(--danger-color)">Error loading files.</div>';
        }
    }

    function updateStorageUI() {
        const usedMB = (currentUsedBytes / (1024 * 1024)).toFixed(2);
        const percent = (currentUsedBytes / MAX_STORAGE_BYTES) * 100;
        
        document.getElementById('storage-text').innerText = `${usedMB} MB / 25.00 MB`;
        const fillBar = document.getElementById('storage-fill');
        
        fillBar.style.width = Math.min(percent, 100) + "%";
        
        fillBar.className = "storage-fill";
        if(percent > 80) fillBar.classList.add("warning");
        if(percent >= 100) fillBar.classList.add("danger");
    }
</script>
</body>
</html>